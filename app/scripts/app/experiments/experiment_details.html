<div ng-if="loading">
  <div class="row">
    <div class="col-sm-6 col-sm-offset-3">
      <div class="panel">
        <div class="panel-heading">
          <h3>
            Please wait
            <other-experiments model-slug="model_slug"></other-experiments>
          </h3>
        </div>
        <div class="panel-body">
          We are loading the data corresponding to your experiment.
        </div>
      </div>
    </div>
  </div>
</div>

<div ng-cloak ng-if="!loading">

  <div class="row">
    <div class="col-xs-12">
      <div class="panel" style="margin-bottom: 25px">
        <div class="panel-heading">
          <h3>
            Results of Experiment
            <b ng-bind="experiment.name"></b>
            on
            <a ui-sref="models-edit({slug: experiment.model.slug, isCopy: false})" ng-bind="experiment.model.title"></a>
            <other-experiments model-slug="model_slug"></other-experiments>
            <button class="btn btn-primary pull-right" ng-cloak style="margin: 1px 5px" ng-class="{'disabled': sharing_working }" ng-click="experiment.shared ? mark_experiment_as_unshared() : mark_experiment_as_shared()">
              <span ng-class="{'fa fa-spin fa-spinner': sharing_working}"></span>
              <span ng-bind="experiment.shared ? 'Unshare experiment' : 'Share experiment'"></span>
            </button>
          </h3>
          <h5>Created {{ experiment.created | fromNow }} by {{ experiment.createdBy.fullname }}</h5>
        </div>
      </div>

      <div class="row">

        <div class="col-xs-3">
          <div class="panel">
            <div class="panel-body">
              <h3>Methods:</h3>
              <ul>
                <li ng-repeat="algorithm in experiment.algorithms track by $index">
                  <div style="max-width: calc(100% - 20px); display: inline-block; vertical-align: top">
                    <span ng-bind="algorithm.name"></span>
                  </div>
                </li>
              </ul>
              <h3 ng-if="experiment.validations.length">Validations:</h3>
              <ul>
                <li ng-repeat="validation in experiment.validations">
                  <span ng-bind="validation.code"></span>:
                  <span ng-bind="validation.parameters[0].value"></span>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="col-sm-9">

          <div class="panel" ng-if="!experiment.finished">
            <div class="panel-heading">
              <h3>
                <span class="fa fa-spinner fa-spin"></span>
                Your experiment is currently running.
              </h3>
            </div>
            <div class="panel-body">
              <p>
                Please check back in a few minutes. This page will automatically refresh once your experiment has finished executing.
              </p>
            </div>
          </div>
          <div class="panel" ng-if="experiment.hasError">
            <div class="panel-heading">
              <h3>
                <span class="fa fa-warning" style="color: darkorange"></span>
                An error has occurred.
              </h3>
            </div>
            <div class="panel-body">
              An error has occurred while running your experiment
              <b ng-bind="experiment.name"></b>. Here's the message:
              <br>
              <br>
              <pre ng-bind="experiment.result"></pre>
            </div>
          </div>

          <div class="experiment-details" ng-if="experiment.finished && !experiment.hasError" ng-cloak>

            <uib-tabset active="0" ng-if="isFederationResult">
                <uib-tab heading="{{ experiment.nodeName }}" ng-repeat="experiment in experiments">
                    <div class="panel bordered">
                        <div class="panel-body">
                            <uib-tabset active="0">
                                <uib-tab ng-repeat="method in experiment.methods" heading="{{ method.name }}">
                                    <div class="panel bordered">
                                        <div class="panel-body">
                                            <uib-tabset>
                                                <uib-tab heading="Cross-validation" ng-if="method.overview_charts.length">
                                                    <div class="panel bordered">
                                                        <div class="panel-body">
                                                            <uib-accordion close-others="false">
                                                                <div uib-accordion-group ng-if="method.overview_charts" is-open="true">
                                                                    <div class="row">
                                                                        <div class="single-legend col-sm-12"></div>
                                                                    </div>

                                                                    <div class="row overview-charts">
                                                                        <div class="col-sm-3 highcharts-container" ng-repeat="chart_config in method.overview_charts" style="width: 200px; height: 200px; margin: 1em 0">
                                                                            <highchart class="highcharts-container" config="chart_config"></highchart>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div uib-accordion-group is-open="false">
                                                                    <uib-accordion-heading>
                                                                        <span class="ti ti-list"></span>
                                                                        Raw JSON
                                                                    </uib-accordion-heading>
                                                                    <pretty-json collapse="hideJson" data="experiment.raw"></pretty-json>
                                                                </div>

                                                            </uib-accordion>
                                                        </div>
                                                    </div>
                                                </uib-tab>

                                                <uib-tab ng-repeat="validation in method.validations" heading="{{ validation.title }}">
                                                    <div class="panel bordered">
                                                        <div class="panel-body">
                                                            <method-result data="validation"></method-result>
                                                        </div>
                                                    </div>
                                                </uib-tab>

                                            </uib-tabset>
                                        </div>
                                    </div>
                                </uib-tab>
                            </uib-tabset>
                        </div>
                    </div>
                </uib-tab>
            </uib-tabset>

            <uib-tabset active="0" ng-if="!isFederationResult">

              <uib-tab heading="Overview" ng-if="overview_charts.length">
                <div class="panel bordered">
                  <div class="panel-body">

                    <uib-accordion close-others="false">
                      <div uib-accordion-group ng-if="overview_charts" is-open="true">
                        <uib-accordion-heading>
                          <span class="ti ti-check-box"></span>
                          Results: Cross-validation
                        </uib-accordion-heading>

                        <div class="row">
                          <div class="single-legend col-sm-12"></div>
                        </div>

                        <div class="row overview-charts">
                          <div class="col-sm-3 highcharts-container" ng-repeat="chart_config in overview_charts" style="width: 200px; height: 200px; margin: 1em 0">
                            <highchart class="highcharts-container" config="chart_config"></highchart>
                          </div>
                        </div>
                      </div>

                      <div uib-accordion-group is-open="false">
                        <uib-accordion-heading>
                          <span class="ti ti-list"></span>
                          Raw JSON
                        </uib-accordion-heading>
                        <pretty-json collapse="hideJson" data="experiment.display.raw"></pretty-json>
                      </div>
                    </uib-accordion>

                  </div>
                </div>
              </uib-tab>

              <uib-tab ng-repeat="method in experiment.display.methods" heading="{{ method.name }}">
                <div class="panel bordered">
                  <div class="panel-body">
                    <method-result data="method"></method-result>
                  </div>
                </div>
              </uib-tab>

            </uib-tabset>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
