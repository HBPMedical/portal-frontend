<div ng-if="loading">
  <div class="row">
    <div class="col-sm-6 col-sm-offset-3">
      <div class="panel">
        <div class="panel-heading">
          <h3>
            Please wait
            <other-experiments model-slug="model_slug"></other-experiments>
          </h3>
        </div>
        <div class="panel-body">
          We are loading the data corresponding to your experiment.
        </div>
      </div>
    </div>
  </div>
</div>

<div ng-cloak ng-if="!loading">

  <div class="row">
    <div class="col-xs-12">
      <div class="panel">
        <div class="panel-heading">
          <h3>
            Results of Experiment
            <b ng-bind="experiment.name"></b>
            on <a ui-sref="models-edit({slug: experiment.model.slug, isCopy: false})" ng-bind="experiment.model.title"></a>
            <other-experiments model-slug="model_slug"></other-experiments>
            <button class="btn btn-primary pull-right"
                    ng-cloak
                    style="margin: 1px 5px"
                    ng-class="{'disabled': sharing_working }"
                    ng-click="experiment.shared ? mark_experiment_as_unshared() : mark_experiment_as_shared()">
              <span ng-class="{'fa fa-spin fa-spinner': sharing_working}"></span>
              <span ng-bind="experiment.shared ? 'Unshare experiment' : 'Share experiment'"></span>
            </button>
          </h3>
          <h5>Created {{ experiment.created | fromNow }} by {{ experiment.createdBy.fullname }}</h5>
        </div>
      </div>

      <div class="row">

        <div class="col-xs-3">
          <div class="panel">
            <div class="panel-body">
              <h3>Algorithms:</h3>
              <ul>
                <li ng-repeat="experiment in algorithms track by $index">
                  <div style="max-width: calc(100% - 20px); display: inline-block; vertical-align: top">
                    <span ng-bind="experiment.name"></span>
                  </div>
                </li>

              </ul>
              <h3 ng-if="validations.length">Validations:</h3>
              <ul>
                <li ng-repeat="validation in validations">
                  <span ng-bind="validation.label"></span>:
                  <span ng-bind="validation.parameters[0].value"></span>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="col-sm-9">

          <div class="panel" ng-if="!experiment.finished">
            <div class="panel-heading">
              <h3>
                <span class="fa fa-spinner fa-spin"></span>
                Your experiment is currently running.
              </h3>
            </div>
            <div class="panel-body">
              <p>
                Please check back in a few minutes. This page will automatically
                refresh once your experiment has finished executing.
              </p>
            </div>
          </div>
          <div class="panel" ng-if="experiment.hasError">
            <div class="panel-heading">
              <h3>
                <span class="fa fa-warning" style="color: darkorange"></span>
                An error has occurred.
              </h3>
            </div>
            <div class="panel-body">
              An error has occurred while running your experiment
              <b ng-bind="experiment.name"></b>. Here's the message:
              <br><br>
              <pre ng-bind="experiment.result"></pre>
            </div>
          </div>
          <div ng-if="experiment.finished && !experiment.hasError" ng-cloak>
            <tabset active="0">

              <tab heading="Overview" ng-if="overview_graph_config.series.length">
                <div class="panel">
                  <div class="panel-body">

                    <highchart config="overview_graph_config" ng-if="show_overview_graph"></highchart>

                    <button class="btn btn-default" ng-click="hideJson = !hideJson" ng-init="hideJson=true">
                      <span ng-bind="hideJson ? 'Show' : 'Hide'"></span> raw JSON
                    </button>
                    <pre collapse="hideJson" ng-bind="experiment.result"></pre>
                  </div>
                </div>

              </tab>

              <tab ng-repeat="experiment_result in result" heading="{{ experiment_result.name }}">
                <div class="panel" ng-if="experiment.finished && !experiment.hasError">


                  <div class="panel-body">
                    <div ng-if="experiment_result.data.cells.validations && experiment_result.data.cells.validations.length > 0">

                      <div ng-switch="get_display_type(experiment_result)">
                        <div ng-switch-when="'regression'">
                          <h4>Cross-Validation results (Regression)</h4>
                          <div>
                            <table class="table table-striped table-bordered">
                              <tr>
                                <th>
                                  Mean square error
                                </th>
                                <td ng-bind="experiment_result.data.cells.validations[0].data.average.MSE"></td>
                              </tr>
                              <tr>
                                <th>
                                  Root mean square error
                                </th>
                                <td ng-bind="experiment_result.data.cells.validations[0].data.average.RMSE"></td>
                              </tr>
                              <tr>
                                <th>
                                  Coefficient of determination (R&sup2;)
                                </th>
                                <td ng-bind="experiment_result.data.cells.validations[0].data.average.R2"></td>
                              </tr>
                              <tr>
                                <th>
                                  Fac2 fit ratio
                                </th>
                                <td ng-bind="experiment_result.data.cells.validations[0].data.average.FAC2"></td>
                              </tr>
                            </table>
                          </div>
                        </div>
                      </div>
                      <div ng-switch-when="'classification'">
                        <h4>Cross-Validation results (Classification)</h4>
                        <div>
                          <table class="table table-striped table-bordered">
                            <tr>
                              <th>
                                Confusion Matrix
                              </th>
                              <td>
                                <table>
                                  <tr ng-repeat="row in experiment_result.data.cells.validations[0].data.average.confusion_matrix">
                                    <td ng-repeat="elem in row" ng-bind="elem"></td>
                                  </tr>
                                </table>
                              </td>
                            </tr>
                          </table>
                        </div>
                      </div>
                      <div ng-switch-when="'linearRegression'">
                        <h4>Results</h4>

                        <table class="table table-striped table-bordered">
                          <tr>
                            <th>Variable</th>
                            <th>Coefficients</th>
                            <th>Standard Error</th>
                            <th>T-statistic</th>
                            <th>P-value</th>
                          </tr>
                          <tr ng-repeat="(name, value) in experiment_result.data.cells.summary.init.coefficients">
                            <td ng-bind="variable_title(name)"></td>
                            <td ng-bind="value.estimate | number"></td>
                            <td ng-bind="value.std_error | number"></td>
                            <td ng-bind="value.t_value | number"></td>
                            <td>
                              <span ng-bind="value.p_value | number"></span>
                              <span ng-bind="pvalue_quality(value.p_value)"></span>
                            </td>
                          </tr>
                        </table>

                        <div>
                          <p>
                            <b>Degrees of freedom: </b>
                            <span ng-bind="experiment_result.data.cells.summary.init.degrees_freedom[1]"></span>
                          </p>
                        </div>

                        <div>
                          <p>
                            <b>Residuals </b>
                          </p>
                          <table class="table table-bordered">
                            <tr>
                              <th>Min</th>
                              <th>Q1</th>
                              <th>Median</th>
                              <th>Q3</th>
                              <th>Max</th>
                            </tr>
                            <tr>
                              <td ng-bind="experiment_result.data.cells.summary.init.residuals.min | number"></td>
                              <td ng-bind="experiment_result.data.cells.summary.init.residuals.q1 | number"></td>
                              <td ng-bind="experiment_result.data.cells.summary.init.residuals.median | number"></td>
                              <td ng-bind="experiment_result.data.cells.summary.init.residuals.q3 | number"></td>
                              <td ng-bind="experiment_result.data.cells.summary.init.residuals.max | number"></td>
                            </tr>
                          </table>
                        </div>

                        <div>
                          <p><b>Covariance matrix</b></p>
                          <table class="table table-condensed table-bordered">
                            <tr ng-repeat="row in experiment_result.data.cells.summary.init.cov_unscaled">
                              <td ng-repeat="cell in row" ng-bind="cell | number"></td>
                            </tr>
                          </table>
                        </div>
                      </div>
                      <div ng-switch-default>
                        <h1>Results</h1>
                        <p></p>
                        <div class="panel-body">
                          The methods ran successfully but unfortunately we are not yet able to display the results in a nicely way.
                          <br>
                          Here's the raw output:
                          <br><br>
                          <pre ng-bind="experiment.result"></pre>
                        </div>
                      </div>
                    </div>
                  </div>
              </tab>
            </tabset>

          </div>

          <!--div class="panel" ng-if="experiment.finished && !experiment.hasError">
            <div class="panel-body">


            </div>
          </div-->

        </div>


      </div>

    </div>

  </div>

</div>
