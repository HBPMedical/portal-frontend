<div ng-if="loading">
  <div class="row">
    <div class="col-sm-6 col-sm-offset-3">
      <div class="panel">
        <div class="panel-heading">
          <h3>
            Please wait
            <other-experiments model-slug="model_slug"></other-experiments>
          </h3>
        </div>
        <div class="panel-body">
          We are loading the data corresponding to your experiment.
        </div>
      </div>
    </div>
  </div>
</div>

<div ng-cloak ng-if="!loading">

  <div class="row">
    <div class="col-xs-12">
      <div class="panel">
        <div class="panel-heading">
          <h3>
            Results of Experiment
            <b ng-bind="experiment.name"></b>
            on <a ui-sref="models-edit({slug: experiment.model.slug, isCopy: false})" ng-bind="experiment.model.title"></a>
            <other-experiments model-slug="model_slug"></other-experiments>
            <button class="btn btn-primary pull-right"
                    ng-cloak
                    style="margin: 1px 5px"
                    ng-class="{'disabled': sharing_working }"
                    ng-click="experiment.shared ? mark_experiment_as_unshared() : mark_experiment_as_shared()">
              <span ng-class="{'fa fa-spin fa-spinner': sharing_working}"></span>
              <span ng-bind="experiment.shared ? 'Unshare experiment' : 'Share experiment'"></span>
            </button>
          </h3>
          <h5>Created {{ experiment.created | fromNow }} by {{ experiment.createdBy.fullname }}</h5>
        </div>
      </div>

      <div class="row">

        <div class="col-xs-3">
          <div class="panel">
            <div class="panel-body">
              <h3>Algorithms:</h3>
              <ul>
                <li ng-repeat="algorithm in experiment.algorithms track by $index">
                  <div style="max-width: calc(100% - 20px); display: inline-block; vertical-align: top">
                    <span ng-bind="algorithm.name"></span>
                  </div>
                </li>
              </ul>
              <h3 ng-if="experiment.validations.length">Validations:</h3>
              <ul>
                <li ng-repeat="validation in experiment.validations">
                  <span ng-bind="validation.code"></span>:
                  <span ng-bind="validation.parameters[0].value"></span>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="col-sm-9">

          <div class="panel" ng-if="!experiment.finished">
            <div class="panel-heading">
              <h3>
                <span class="fa fa-spinner fa-spin"></span>
                Your experiment is currently running.
              </h3>
            </div>
            <div class="panel-body">
              <p>
                Please check back in a few minutes. This page will automatically
                refresh once your experiment has finished executing.
              </p>
            </div>
          </div>
          <div class="panel" ng-if="experiment.finished && experiment.hasError">
            <div class="panel-heading">
              <h3>
                <span class="fa fa-warning" style="color: darkorange"></span>
                An error has occurred.
              </h3>
            </div>
            <div class="panel-body">
              An error has occurred while running your experiment
              <b ng-bind="experiment.name"></b>. Here's the message:
              <br><br>
              <pre ng-bind="experiment.result"></pre>
            </div>
          </div>
          <div class="experiment-details" ng-if="experiment.finished && !experiment.hasError" ng-cloak>
            <tabset active="0">

              <tab heading="Overview" ng-if="overview_charts.length">
                <div class="panel">
                  <div class="panel-body">
                    <div class="row">
                      <div class="single-legend col-sm-12"></div>
                    </div>
                    <div class="row overview-charts">
                      <div class="col-sm-3" ng-repeat="chart_config in overview_charts">
                        <highchart config="chart_config"></highchart>
                      </div>
                    </div>
                    <div class="pull-right">
                      <button class="btn btn-default" ng-click="hideJson = !hideJson" ng-init="hideJson=true">
                        <span ng-bind="hideJson ? 'Show' : 'Hide'"></span> raw JSON
                      </button>
                      <pre collapse="hideJson" ng-bind="experiment.raw"></pre>
                    </div>
                  </div>
                </div>
              </tab>

              <tab ng-repeat="method in experiment.display.methods" heading="{{ method.name }}">
                <div class="panel">
                  <div class="panel-body">
                    <div ng-switch="method.type">
                      <div ng-switch-when="regression">
                        <h4>Cross-Validation results (Regression)</h4>
                        <div class="row">
                          <div ng-repeat="metric in method.metrics | filter: {type: 'numeric'}" class="col-sm-4">
                            <span tooltip-placement="top" tooltip="{{ metric.tooltip }}"><span ng-bind="metric.label"></span>: <span ng-bind="metric.value | number:3"></span>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div ng-switch-when="binary_classification">
                        <h4>Cross-Validation results (Binary Classification)</h4>
                        <div>
                          <table class="table table-condensed table-bordered">
                            <tr>
                              <th>
                                Confusion Matrix
                              </th>
                              <td>
                                <confusion-matrix data="method.metrics['Confusion matrix']"></confusion-matrix>
                              </td>
                            </tr>
                          </table>
                        </div>
                      </div>
                      <div ng-switch-when="classification">
                        <h4>Cross-Validation results (Classification)</h4>
                        <div>
                          <div class="row">
                            <div ng-repeat="metric in method.metrics | filter: {type: 'confusion_matrix'}" class="col-sm-6">
                              <span ng-bind="metric.label"></span>: <confusion-matrix data="metric.value"></confusion-matrix>
                            </div>
                          </div>
                          <div class="row">
                            <div ng-repeat="metric in method.metrics | filter: {type: 'numeric'}" class="col-sm-4">
                            <span tooltip-placement="top" tooltip="{{ metric.tooltip }}"><span ng-bind="metric.label"></span>: <span ng-bind="metric.value | number:3"></span>
                            </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div ng-switch-when="linearRegression">
                        <h4>Results</h4>

                        <table class="table table-striped table-bordered">
                          <tr>
                            <th>Variable</th>
                            <th>Coefficients</th>
                            <th>Standard Error</th>
                            <th>T-statistic</th>
                            <th>P-value</th>
                          </tr>
                          <tr ng-repeat="(name, value) in method.raw.data.cells.summary.init.coefficients">
                            <td ng-bind="variable_title(name)"></td>
                            <td ng-bind="value.estimate | number"></td>
                            <td ng-bind="value.std_error | number"></td>
                            <td ng-bind="value.t_value | number"></td>
                            <td>
                              <span ng-bind="value.p_value | number"></span>
                              <span ng-bind="pvalue_quality(value.p_value)"></span>
                            </td>
                          </tr>
                        </table>

                        <div>
                          <p>
                            <b>Degrees of freedom: </b>
                            <span ng-bind="method.raw.data.cells.summary.init.degrees_freedom[1]"></span>
                          </p>
                        </div>

                        <div>
                          <p>
                            <b>Residuals </b>
                          </p>
                          <table class="table table-bordered">
                            <tr>
                              <th>Min</th>
                              <th>Q1</th>
                              <th>Median</th>
                              <th>Q3</th>
                              <th>Max</th>
                            </tr>
                            <tr>
                              <td ng-bind="method.raw.data.cells.summary.init.residuals.min | number"></td>
                              <td ng-bind="method.raw.data.cells.summary.init.residuals.q1 | number"></td>
                              <td ng-bind="method.raw.data.cells.summary.init.residuals.median | number"></td>
                              <td ng-bind="method.raw.data.cells.summary.init.residuals.q3 | number"></td>
                              <td ng-bind="method.raw.data.cells.summary.init.residuals.max | number"></td>
                            </tr>
                          </table>
                        </div>

                        <div>
                          <p><b>Covariance matrix</b></p>
                          <table class="table table-condensed table-bordered">
                            <tr ng-repeat="row in method.raw.data.cells.summary.init.cov_unscaled">
                              <td ng-repeat="cell in row" ng-bind="cell | number"></td>
                            </tr>
                          </table>
                        </div>
                      </div>
                      <div ng-switch-default>
                        <h1>Results</h1>
                        <p></p>
                        <div class="panel-body">
                          The methods ran successfully but unfortunately we are not yet able to display the results in a nicely way.
                          <br>
                          Here's the raw output:
                          <br><br>
                          <pre ng-bind="experiment.result"></pre>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </tab>
            </tabset>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
