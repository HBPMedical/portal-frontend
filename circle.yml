version: 2
jobs:
  build:
    docker:
      # Recursive self-reference...
      - image: hbpmip/docker-compose-for-ci:17.06-1
    environment:
      - CIRCLECI: true
    steps:
      - setup_remote_docker:
          version: 17.06.0-ce
      - checkout
      - run: echo "A First hello"
      - run:
          name: "Install requirements"
          command: |
            docker --version
#      - run:
#          name: "Build the project"
#          command: |
#            docker build -t hbpmip/portal-frontend .
  test:
    docker:
      - image: hbpmip/docker-compose-for-ci:17.06-1
      - image: circleci/openjdk:8-jdk-browsers
    environment:
          - CIRCLECI: true
    steps:
      - setup_remote_docker:
          version: 17.06.0-ce
      - checkout
      - run:
          name: "Install requirements"
          command: |
            docker --version
#      - run:
#          name: "Install Java"
#          command: |
#            apk update && apk add default-jdk
      - run:
          name: "Build the project"
          command: |
            docker build -t hbpmip/portal-frontend-dev -f ./Dockerfile-e2e-tests .
      - run:
          name: "Run the project"
          command: |
            docker run -it --rm -p8000:8000 hbpmip/portal-frontend-dev
#          background: true
#      - run:
#          name: "Install dockerize"
#          command: |
#            apk update && apk add ca-certificates && update-ca-certificates && apk add openssl
#            wget http://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
#            tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
#            rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
#          environment:
#            DOCKERIZE_VERSION: v0.3.0
#      - run:
#          name: "Wonderful task"
#          command: |
#            pwd
#            ls -al

#      - run:
#          name: "Wait for project Run"
#          command: dockerize -wait http://localhost:8000 -timeout 1m
#      - run:
#          name: "Test the project"
#          command: |
#            docker exec -it hbpmip/portal-frontend-dev bash gulp protractor-go
      - run:
          name: "Stop the project"
          command: |
            docker stop hbpmip/portal-frontend-dev
workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test
